<!DOCTYPE html>
<html>
<head>
	<title>HighViz</title>
</head>      

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.24/browser.js"></script>
    
      <script type="text/javascript" src="https://fb.me/react-with-addons-0.14.0.js"></script>
    
      <script type="text/javascript" src="https://fb.me/react-dom-0.14.0.js"></script>




<body>

<div id='interface1'></div>

<script type='text/babel'>

var entitiesToImages = new Map();

function getImageLinksFromFlickrApi(tag) {
	var flickrAPI = "http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?";
	return $.getJSON(flickrAPI, {
		tags: tag,
		tagmode: "any",
		format: "json"
	}).then(function(data) {
		return data.items.map(function(item) { return item.media.m; });
	});
}

function loadImagesForEntities(entities) {
	console.log('Loading images for entities');

	var allImagesLoaded = $.Deferred();

	$.when(...entities.map(function(entity){
		if(entitiesToImages.has(entity)) return; // cache

		var imagesLoadedForEntity = $.Deferred();
		getImageLinksFromFlickrApi(entity).then(function(links){
			console.log('Loaded images for entity: "'+entity+'"');
			entitiesToImages.set(entity, links)
			imagesLoadedForEntity.resolve()
		});

		return imagesLoadedForEntity;
	})).then(() => { allImagesLoaded.resolve() });

	return allImagesLoaded.promise();
}

var ParamsInput = React.createClass({
	getInitialState: function(){
		return {
			entities_text: 'forest,leaves',
			weights_text: '80,20',
			entities: ['forest','leaves'],
			weights: [80,20]
		};
	},

	entitiesOnChange: function(e){
		this.setState({ entities_text: e.target.value, entities: e.target.value.split(',') })
	},

	weightsOnChange: function(e){
		this.setState({ weights_text: e.target.value, weights: e.target.value.split(',') })
	},

	weightsAndEntities: function(){
		var self = this;
		var waes = [];
		var i = 0;
		this.state.entities.map(function(entity){
			var weight = self.state.weights[i];
			if(weight) {
				waes.push({ entity: entity , weight: weight });
			}
			i++;
		})
		return waes;
	},

	getImages: function() {
		var self = this;
		loadImagesForEntities([this.state.entities[0]]).then(function(){
			var imgs = [];

			for(var [entity, imgs] of entitiesToImages.entries()) {
				for(var img of imgs) {
					imgs.push(<img key={img} src={img}/>);
				}
			}
			
			self.setState({ imgs: imgs })
		});
	},

	componentDidMount: function() {
		var self = this;
		setTimeout(function(){self.getImages()}, 400);
	},

	render: function(){
		return (
			<div>
				<label>entities:</label><input type='text' value={this.state.entities_text} onChange={this.entitiesOnChange}/>
				<label>weights:</label><input type='text' value={this.state.weights_text} onChange={this.weightsOnChange}/>

				{this.state.imgs}

			</div>
		);
	}

})

ReactDOM.render(<ParamsInput/>, document.getElementById('interface1'));

</script>

</body>
</html>
